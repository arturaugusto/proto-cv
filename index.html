<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Camera selection</title>
  <link rel="stylesheet" href="./app.css" />

</head>

<body>
  <main>
    <div class="controls">
      
      <div id="app">
        <!-- <pre>{{ state }}</pre> -->

        <div v-for="conf in state.confs">
          <div v-for="p in conf.pipeline">
            <div>
              
              <input
                type="checkbox"
                name=""
                v-model="p[0]">

              {{p[1]}}{{p[2] !== undefined ? ':' : ''}}

              <span v-if="p[1] === 'upsample'">
                coefficient: <input
                  type="number"
                  v-model="p[2]"
                  :step="1"
                  :min="1"
                  :max="10">

                <select v-model="p[3]">
                  <option>nearest</option>
                  <option>bicubic</option>
                </select>

              </span>


              <span v-if="p[1] === 'norm'">
                <select v-model="p[2]">
                  <option>l2</option>
                  <option>minmax</option>
                </select>
              </span>


              <span v-if="p[1] === 'gaussianBlur'">
                H: <input
                  type="number"
                  v-model="p[2]"
                  :step="2"
                  :min="3"
                  :max="8">
                H: <input
                  type="number"
                  v-model="p[3]"
                  :step="2"
                  :min="3"
                  :max="8">
              </span>

              <span v-if="p[1] === 'colorSegmentation'">
                Clusters: <input
                  type="number"
                  v-model="p[2]"
                  :step="1"
                  :min="2"
                  :max="10">
              </span>

              <span v-if="p[1] === 'adaptiveThreshold'">
                Size: <input
                  type="number"
                  v-model="p[2]"
                  :step="1"
                  :min="0"
                  :max="100">
                Value: <input
                  type="number"
                  v-model="p[3]"
                  :step="1"
                  :min="0"
                  :max="100">
              </span>

              <span v-if="p[1] === 'cannyEdges'">
                High Threshold: <input
                  type="number"
                  v-model="p[2]"
                  :step="0.05"
                  :min="0"
                  :max="1">
                Low Threshold: <input
                  type="number"
                  v-model="p[3]"
                  :step="0.05"
                  :min="0"
                  :max="1">
              </span>

              <span v-if="p[1] === 'dilate'">
                W: <input
                  type="number"
                  v-model="p[2]"
                  :step="1"
                  :min="1"
                  :max="40">
                H: <input
                  type="number"
                  v-model="p[3]"
                  :step="1"
                  :min="1"
                  :max="40">
              </span>

              <span v-if="p[1] === 'erode'">
                W: <input
                  type="number"
                  v-model="p[2]"
                  :step="1"
                  :min="1"
                  :max="40">
                H: <input
                  type="number"
                  v-model="p[3]"
                  :step="1"
                  :min="1"
                  :max="40">
              </span>



              <span v-if="p[1] === 'pcLines'">
                N lines: <input
                  type="number"
                  v-model="p[5]"
                  :step="step(p)"
                  :min="1"
                  :max="50">
                Layers: <input
                  type="number"
                  v-model="p[2]"
                  :step="1"
                  :min="1"
                  :max="5">
              </span>



            </div>
          </div>
        </div>

      </div>
      
      <button id="button">Get camera</button>
      <select id="select">
        <option></option>
      </select>
    </div>

    <video id="video" autoplay playsinline></video>
    
    <div class="wrapper video-wrapper">
      <canvas id="videoCanvas"></canvas>
      <canvas id="roiCanvas"></canvas>
    </div>
    
    <canvas id="roi1Canvas" style="visibility: collapse;"></canvas>
    <canvas id="mask1Canvas" style="visibility: collapse;"></canvas>
    <canvas id="pclines1Canvas" style="visibility: collapse;"></canvas>


    <canvas id="roi2Canvas" style="visibility: collapse;"></canvas>
    <canvas id="mask2Canvas" style="visibility: collapse;"></canvas>
    <canvas id="pclines2Canvas" style="visibility: collapse;"></canvas>

    
  </main>
  
  <script src="./gammacv.min.js"></script>

  <script type="module">
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    createApp({
      data() {
        return {
          state: {},
        }
      },
      methods: {
        step (p) {
          if (p[1] === 'dilate' || p[1] === 'erode') return 2
          if (p[1] === 'cannyEdges') return 0.01
          return 1
        },
        min (p) {
          if (p[1] === 'dilate' || p[1] === 'erode') return 1
          return 0
        },
        max (p) {
          if (p[1] === 'dilate' || p[1] === 'erode') return 9
          if (p[1] === 'pcLines') return 50
          return 1
        }
      },
      mounted () {
        let confTemplate = {
          region: null,
          vTarget: 'd',
          hTarget: 'w',
          pipeline: [
            [false, 'upsample', 3, 'nearest'],
            [false, 'norm', 'l2'],
            [false, 'grayscale'],
            [false, 'gaussianBlur', 3, 3],
            [false, 'colorSegmentation', 3],
            [false, 'adaptiveThreshold', 5, 15],
            [false, 'sobelOperator'],
            [false, 'cannyEdges', 0.25, 0.85],
            [false, 'dilate', 3, 3],
            [false, 'erode', 3, 3],
            [false, 'pcLines', 3, 2, 2]
          ],
        }

        this.state = {
          roiConfSel: null,
          confs: [
            Object.assign({}, confTemplate),
          ]
        }

        let urlState = window.location.href.split('#/')[1]
        if (urlState) {
          Object.assign(this.state, JSON.parse(decodeURI(urlState)))
          this.state.confs.forEach(loadedConf => {
            loadedConf.pipeline = confTemplate.pipeline.map(pItemTpl => {
              // add if finter don exists on loaded conf
              return loadedConf.pipeline.filter(p => p[1] === pItemTpl[1])[0] || pItemTpl
            })
          })
        }

        this.state.confs[0].region ||= [10, 10, roiCanvas.width/2-10, 100]
        window.state = this.state
      }
    }).mount('#app')
  </script>

  <script src="./app.js"></script>
  <script src="./input.js"></script>
  <script src="./preprocess.js"></script>

</body>

</html>