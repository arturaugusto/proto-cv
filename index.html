<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Proto-CV</title>
  <link rel="stylesheet" href="./app.css" />
  <link rel="stylesheet" href="./chota.min.css" />


  <style>
    input, select {
      border-radius: 0px !important;
    }

    .p-param {
/*      width: 100px !important;*/
    }

    ._p-param-wrap {
      display: flex;
    }

    button {
      margin-left: 10px;
      margin-bottom: 5px;
    }
  </style>
</head>

<body>
  <main>
    <div class="controls">
      
      <div class="row">
        <div class="col">
          Camera: <select id="select" style="width: 300px;display: inline-block;">
            <option></option>
          </select>
        </div>
      </div>

      <div id="app">
        <!-- <pre>{{ state }}</pre> -->


        <div class="row">

          <div v-for="conf in state.confs" class="col-2" @click="focusCol($event)">
            
            <div>
              <span class="is-vertical-align"><span style="width: 22px;">x:</span><input
                  class="p-param"
                  type="number"
                  name=""
                  v-model="conf.region[0]"></span>
              <span class="is-vertical-align"><span style="width: 22px;">y:</span><input
                  class="p-param"
                  type="number"
                  name=""
                  v-model="conf.region[1]"></span>
              <span class="is-vertical-align"><span style="width: 22px;">w:</span><input
                  class="p-param"
                  type="number"
                  name=""
                  v-model="conf.region[2]"></span>
              <span class="is-vertical-align"><span style="width: 22px;">h:</span><input
                  class="p-param"
                  type="number"
                  name=""
                  v-model="conf.region[3]"></span>
            </div>
            

            <div>
              <input
                class="p-param"
                type="checkbox"
                name=""
                v-model="conf.showpp">
                <strong>Show processed</strong>
            </div>
            

            <div v-for="(p, i) in conf.pipeline" class="bd-dark" :class="{'bg-light': i % 2, 'bg-grey': !(i % 2)}">

              <div style="padding: 6px;">
                <div>
                  <input
                    class="p-param"
                    type="checkbox"
                    name=""
                    v-model="p[0]"><strong> {{p[1]}}{{p[2] !== undefined ? ':' : ''}} </strong>
                </div>

                <span v-if="p[1] === 'upsample'" class="p-param-wrap">
                  coefficient: <input
                    class="p-param"
                    type="number"
                    v-model="p[2]"
                    :step="1"
                    :min="1"
                    :max="10">

                  <select v-model="p[3]" class="p-param">
                    <option>nearest</option>
                    <option>bicubic</option>
                  </select>

                </span>


                <span v-if="p[1] === 'norm'" class="p-param-wrap">
                  <select v-model="p[2]" class="p-param">
                    <option>l2</option>
                    <option>minmax</option>
                  </select>
                </span>


                <span v-if="p[1] === 'gaussianBlur'" class="p-param-wrap">
                  H: <input
                    class="p-param"
                    type="number"
                    v-model="p[2]"
                    :step="2"
                    :min="3"
                    :max="8">
                  H: <input
                    class="p-param"
                    type="number"
                    v-model="p[3]"
                    :step="2"
                    :min="3"
                    :max="8">
                </span>

                <span v-if="p[1] === 'colorSegmentation'" class="p-param-wrap">
                  Clusters: <input
                    class="p-param"
                    type="number"
                    v-model="p[2]"
                    :step="1"
                    :min="2"
                    :max="10">
                </span>

                <span v-if="p[1] === 'adaptiveThreshold'" class="p-param-wrap">
                  Size: <input
                    class="p-param"
                    type="number"
                    v-model="p[2]"
                    :step="1"
                    :min="0"
                    :max="100">
                  Value: <input
                    class="p-param"
                    type="number"
                    v-model="p[3]"
                    :step="1"
                    :min="0"
                    :max="100">
                </span>

                <span v-if="p[1] === 'cannyEdges'" class="p-param-wrap">
                  High Threshold: <input
                    class="p-param"
                    type="number"
                    v-model="p[2]"
                    :step="0.05"
                    :min="0"
                    :max="1">
                  Low Threshold: <input
                    class="p-param"
                    type="number"
                    v-model="p[3]"
                    :step="0.05"
                    :min="0"
                    :max="1">
                </span>

                <span v-if="p[1] === 'dilate'" class="p-param-wrap">
                  W: <input
                    class="p-param"
                    type="number"
                    v-model="p[2]"
                    :step="1"
                    :min="1"
                    :max="40">
                  H: <input
                    class="p-param"
                    type="number"
                    v-model="p[3]"
                    :step="1"
                    :min="1"
                    :max="40">
                </span>

                <span v-if="p[1] === 'erode'" class="p-param-wrap">
                  W: <input
                    class="p-param"
                    type="number"
                    v-model="p[2]"
                    :step="1"
                    :min="1"
                    :max="40">
                  H: <input
                    class="p-param"
                    type="number"
                    v-model="p[3]"
                    :step="1"
                    :min="1"
                    :max="40">
                </span>



                <span v-if="p[1] === 'pcLines'" class="p-param-wrap">
                  N lines: <input
                    class="p-param"
                    type="number"
                    v-model="p[5]"
                    :step="1"
                    :min="1"
                    :max="50">
                  Layers: <input
                    class="p-param"
                    type="number"
                    v-model="p[2]"
                    :step="1"
                    :min="1"
                    :max="5">
                </span>
              </div>
            </div>
            
            <!-- trigger rects -->
            <div v-for="(t, j) in conf.trigRects" :key="j" class="bd-dark" :class="{'bg-light': j % 2, 'bg-grey': !(j % 2)}" style="padding: 6px;">
              <div><strong>triggerRect</strong></div>
              <span class="p-param-wrap">              
                x: <input
                  class="p-param"
                  type="number"
                  v-model="t.roi[0]"
                  :step="1"
                  :min="1">
                y: <input
                  class="p-param"
                  type="number"
                  v-model="t.roi[1]"
                  :step="1"
                  :min="1">
                w: <input
                  class="p-param"
                  type="number"
                  v-model="t.roi[2]"
                  :step="1"
                  :min="1">
                h: <input
                  class="p-param"
                  type="number"
                  v-model="t.roi[3]"
                  :step="1"
                  :min="1">
                histOn: <input
                  class="p-param"
                  type="number"
                  v-model="t.histOn"
                  :step="0.1"
                  :min="0"
                  :max="1">
                histOff: <input
                  class="p-param"
                  type="number"
                  v-model="t.histOff"
                  :step="0.1"
                  :min="0"
                  :max="1">
                <button class="button primary" @click="conf.trigRects.splice(j,1)">remove</button>
              </span>
            </div>
            <span>
              <button class="button dark" @click="addTrigRect(conf)">add trigRect</button>
            </span>
          </div>
          <div class="col-2">
            <span>
              <button v-if="state && state.confs && state.confs.length < 6" class="button dark" @click="addConfRegion">add pipeline</button>
            </span>
          </div>


        </div>
      </div>
    </div>

    <video id="video" autoplay playsinline></video>
    <div class="wrapper video-wrapper" id="videoWrapper">
      <canvas id="videoCanvas"></canvas>
      <canvas id="roiCanvas"></canvas>
    </div>
    
    <canvas id="roi1Canvas" style="visibility: collapse;"></canvas>
    <canvas id="mask1Canvas" style="visibility: collapse;"></canvas>

    <canvas id="roi2Canvas" style="visibility: collapse;"></canvas>
    <canvas id="mask2Canvas" style="visibility: collapse;"></canvas>

    <canvas id="roi3Canvas" style="visibility: collapse;"></canvas>
    <canvas id="mask3Canvas" style="visibility: collapse;"></canvas>

    <canvas id="roi4Canvas" style="visibility: collapse;"></canvas>
    <canvas id="mask4Canvas" style="visibility: collapse;"></canvas>

    <canvas id="roi5Canvas" style="visibility: collapse;"></canvas>
    <canvas id="mask5Canvas" style="visibility: collapse;"></canvas>

    <canvas id="roi6Canvas" style="visibility: collapse;"></canvas>
    <canvas id="mask6Canvas" style="visibility: collapse;"></canvas>



    
  </main>
  
  <script src="./gammacv.min.js"></script>

  <script type="module">
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    createApp({
      data() {
        return {
          state: {},
        }
      },
      methods: {
        focusCol (e) {
          let roiCanvas = document.getElementById('roiCanvas')
          let targetBc = e.target.getBoundingClientRect()
          roiCanvas.parentElement.style.left = targetBc .x+targetBc.width + 'px'

          
          // console.log(e, roiCanvas)
        },
        addConfRegion () {
          let conf = JSON.parse(JSON.stringify(this.confTemplate))
          conf.region = [10, 10, roiCanvas.width/2-10, 100]
          this.state.confs.push(conf)
          // console.log('lala')
        },
        addTrigRect (conf) {
          console.log(conf)
          conf.trigRects.push({
            roi: [1,1,10,10],
            histOn: 0.7,
            histOff: 0.4,
            state: false
          })
        },
        tooglep (e) {
          console.log(e)
          e.stopPropagation()
        }
      },
      mounted () {
        let confTemplate = {
          region: null,
          vTarget: 'd',
          hTarget: 'w',
          pipeline: [
            [false, 'upsample', 3, 'nearest'],
            [false, 'norm', 'l2'],
            [false, 'grayscale'],
            [false, 'gaussianBlur', 3, 3],
            [false, 'colorSegmentation', 3],
            [false, 'adaptiveThreshold', 5, 15],
            [false, 'sobelOperator'],
            [false, 'cannyEdges', 0.25, 0.85],
            [false, 'dilate', 3, 3],
            [false, 'erode', 3, 3],
            [false, 'pcLines', 3, 2, 2]
          ],
          trigRects: []
        }

        this.confTemplate = confTemplate

        this.state = {
          roiConfSel: null,
          confs: [
            Object.assign({}, confTemplate),
          ]
        }

        let urlState = window.location.href.split('#/')[1]
        if (urlState) {
          Object.assign(this.state, JSON.parse(decodeURI(urlState)))
          this.state.confs.forEach(loadedConf => {
            loadedConf.pipeline = confTemplate.pipeline.map(pItemTpl => {
              // add if filter dony exists on loaded conf
              return loadedConf.pipeline.filter(p => p[1] === pItemTpl[1])[0] || pItemTpl
            })
          })
        }

        this.state.confs.forEach(conf => conf.trigRects ||= [])

        this.state.confs[0].region ||= [10, 10, roiCanvas.width/2-10, 100]
        window.state = this.state
      }
    }).mount('#app')
  </script>

  <script src="./app.js"></script>
  <script src="./input.js"></script>
  <script src="./preprocess.js"></script>

</body>

</html>